<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WritingApp</title>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.slim.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>

    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

    <script src='https://kit.fontawesome.com/a076d05399.js' crossorigin='anonymous'></script>



</head>
<style>
    body {
        background-size: cover;
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-color: #f8f9fa;
        /* Fallback background color */
        margin: 0;
        min-height: 100vh;
        background-image: url("wallpaper-dark.jpg");
        width: 70%;
        margin-left: 10%;
    }

    .chat-container {
        background-image: url("w.jpg");
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        background-color: rgba(255, 255, 255, 0.9);
        /* Semi-transparent white background */
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        /* Box shadow for a card-like appearance */
        border: 1px solid #ccc;
        display: flex;
        /* Use flexbox to control container's height */
        flex-direction: column;
        /* Display latest message at the bottom */
        overflow-y: auto;
    }

    .message-balloon {
        background-color: #035d4c;
        /* Green background for sent messages */
        color: #fff;
        /* Text color for sent messages */
        padding: 10px;
        border-radius: 30px;
        margin-bottom: 10px;
        clear: both;
        float: left;
        width: auto;
        text-align: left;
    }

    .message-balloon-received {
        background-color: #1f2c34;
        /* White background for received messages */
        color: #fff;
        /* Text color for received messages */
        padding: 10px;
        border-radius: 30px;
        margin-bottom: 10px;
        clear: both;
        float: right;
        width: auto;
        text-align: right;
    }

    .username-column {
        border: none;
        width: 20%;
    }

    .message-column {
        border: none;
        width: 60%;
    }

    .time-column {
        border: none;
        width: 10%;
    }

    .actions-column {
        border: none;
        width: 10%;
    }

    .update-button {
        background: none;
        border: none;
        color: #007bff;
        cursor: pointer;
    }

    .delete-button {
        background: none;
        border: none;
        color: #dc3545;
        cursor: pointer;
    }

    /* New style for time */
    .message-time {
        font-size: 12px;
        color: #666;
        text-align: right;
    }


    .conversation-compose .send {
        background: transparent;
        border: 0;
        cursor: pointer;
        flex: 0 0 auto;
        margin-left: 8px;
        margin-right: 8px;
        padding: 0;
        position: relative;
        outline: none;
    }

    .conversation-compose .send .circle {
        background: #008a7c;
        border-radius: 50%;
        color: #fff;
        position: relative;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .conversation-compose .send .circle .iconify-icon {
        font-size: 24px;
        margin-left: 5px;
    }

    #text {
        border: 0;
        flex: 1 1 auto;
        font-size: 16px;
        margin: 0;
        outline: none;
        min-width: 50px;
        margin-left: 30%;
    }

    .iconify-icon {
        height: calc(100% - 68px);
        box-shadow: inset 0 10px 10px -10px #000000;
        overflow-x: hidden;
        padding: 0 16px;
        margin-bottom: 19px;
    }

    #user-img {
        margin-right: 10%;
    }

    #image {
        background-color: #fff;
    }

    /* Small Screens */
</style>

<body>
    <h1>WritingApp</h1>



    <div class="chat-container" id="tableBody">

        <img id="frame" style="display: none;" src="" width="0px" height="0px" />
    </div>



    <input type="text" id="text" required><i onclick="" id="image" class="fa fa-image"></i>
    <button class="send" id="post-button" onclick="post_data()">
        <div class="circle">
            <iconify-icon icon="zmdi:mail-send"></iconify-icon>
        </div>
        </div>
    </button>
    <form class=" mt-5 mx-auto col-6 col-md-8 col-lg-6 was-validated ">
        <div class="form-row">
            <div class="col-md-4 mb-3">
                <input type="name" class="form-control" id="name" placeholder="Jane Doe.." value="" required>
            </div>



            <div class="col-md-4 mb-3">
                <input type="number" class="form-control mb-2" id="Phone" minlength="9" maxlength="10"
                    placeholder="050-1234567.." min="10" required><br />
            </div>


            <div class="custom-file col-md-4 mb-3">

                <input type="file" onchange="add_img()" class="custom-file-input" id="file" required>
                <label class="custom-file-label" for="file"><b>add a picture..</b></label>
            </div>
        </div>

        <button onclick="activation()" class="btn btn-primary col" type="button">connect</button>
        </div>
    </form>
    <!-- <img id="frame" src="" width="300px" height="500px" /> -->
    <script src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.2"></script>

  
    <script>

        class M {
            constructor(_name, _img, _Push, _size_array) {

                this.name = _name
                this.img = _img
                this.Push = _Push
                this.size_array = _size_array
            }
        }

        function activation() {

            M._name = document.getElementById('name').value
            if (M._name !== '') {
                M._size_array = []
            }
            else {
                Swal.fire('Must enter a name', '', 'success')
            }
        }

        function add_img() {
            frame.src = URL.createObjectURL(event.target.files[0]);
            M._img = frame.src
        }

        function isLink_img(text) {
            return (
                text.endsWith("gif") || text.endsWith("png") ||
                text.endsWith("jpg") || text.endsWith("svg") ||
                text.endsWith("jpeg")
            );
        }

        function isLink_youtube(text) {
            return (text.includes("youtu") || text.includes("youtu"));
        }

        function isLink_facebook(text) {
            return (text.includes("facebook"));
        }

        function isLink_tiktok(text) {
            return (text.includes("tiktok"));
        }

        function post_data() {

            let new_user = M._name
            let new_text = document.getElementById('text').value
            let new_time = time_now()
            let img_or_no = isLink_img(new_text)
            let tube_or_no = isLink_youtube(new_text)
            let tiktok_or_no = isLink_tiktok(new_text)
            let facebook_or_on = isLink_facebook(new_text)
            let string_name = "text"

            const input = document.getElementById('text')
            input.value = '';

            
            if (img_or_no === true) {
                string_name = "img"
            }
            if (tiktok_or_no === true) {
                string_name = "tiktok"

            }
            if (tube_or_no === true) {
                string_name = "tube"
            }
            if (facebook_or_on === true) {
                string_name = "face"
                const url = new_text
                const parts = url.split("=");
                const videoId = parts[parts.length - 1];
                new_text = videoId
            }
            const url = 'https://db-nmn5.onrender.com/chats'
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: `{
                            "user": "${new_user}",
                            "${string_name}": "${new_text}",
                            "time": "${new_time}"
                        }`})

        }


        function time_now() {
            const now = new Date();

            const hours = now.getHours();

            const minutes = now.getMinutes();

            const day = now.getDate()

            const Month = now.getMonth() + 1

            const Year = now.getFullYear()

            const seconds = now.getSeconds();
            let time = `${hours}:${minutes}:${seconds}  ${day}/${Month}/${Year}`

            return time
        }

        function Push_update() {
            fetch("https://db-nmn5.onrender.com/chats") // 649 cards
                .then(res => res.json())
                .then(data => {
                    // Save the data in localStorage
                    localStorage.setItem("check", JSON.stringify(data));})

            M._Push = JSON.parse(localStorage.getItem("check"))
            if (M._Push.length === M._size_array.length){

            }
            else {
                M._Push = 0
                get()
            }
        }

        function get() {

            fetch("https://db-nmn5.onrender.com/chats") 
                .then(res => res.json())
                .then(data => {
                    localStorage.setItem("db-chats", JSON.stringify(data));
                })

            M._size_array = JSON.parse(localStorage.getItem("db-chats"))

            let r = document.createElement("tr");


            const postsList = document.getElementById('tableBody')
            postsList.innerHTML = ""

            for (let i = 0; i < M._size_array.length; i++) {
                const row = document.createElement('div')
                let id = M._size_array[i].id
                if (M._size_array[i].user === M._name) {
                    if (M._size_array[i].text !== undefined ) {
                        row.innerHTML = `<br/>
                        <div>
                            <div>
                                <img id="user-img" src="${M._img}" width="50px" height="50px" />
                                    <div ><b>${M._size_array[i].user}</b></div>
                                </div>
                            <div class="message-balloon" id="message-${id}">
                                <div>${M._size_array[i].text}</div>
                                <div><sub>${M._size_array[i].time}</sub></div>
                            </div>
                        </div>`
                        postsList.appendChild(row)
                        addCellClick(`message-${id}`, id)
                    }

                    else {
                        if (M._size_array[i].img !== undefined) {

                            row.innerHTML = `<br/><div>
                    <div><img id="user-img" src="${M._img}" width="50px" height="50px" /><div >
                        <b>${M._size_array[i].user}</b></div></div>
                        <div class="message-balloon" id="message-${id}">
                    <img   src="${M._size_array[i].img}" width="200px" height="200px" />
                    <div><sub>${M._size_array[i].time}</sub></div></div></div>
                    `
                            postsList.appendChild(row)
                            addCellClick(`message-${id}`, id)
                        }
                        if (M._size_array[i].tube !== undefined) {
                            row.innerHTML = `<br/>
                        <div>
                            <div>
                                <img id="user-img" src="${M._img}" width="50px" height="50px" />
                                    <div ><b>${M._size_array[i].user}</b></div>
                                </div>
                            <div class="message-balloon" id="message-${id}">
                                <iframe width="300" height="200" src="https://www.youtube.com/embed/Vaxpu-8m4kw?${M._size_array[i].tube}"
                                 title="YouTube video player" frameborder="0" 
                                 allow="accelerometer; autoplay; clipboard-write;
                                 encrypted-media; gyroscope; picture-in-picture; web-share" 
                                 allowfullscreen></iframe>
                                <div><sub>${M._size_array[i].time}</sub></div>
                            </div>
                        </div>`
                            postsList.appendChild(row)
                            addCellClick(`message-${id}`, id)
                        }
                        if (M._size_array[i].face !== undefined) {
                            runfacebookScript()
                          
                            row.innerHTML = `<br/>
                        <div>
                            <div>
                                <img id="user-img" src="${M._img}" width="50px" height="50px" />
                                    <div ><b>${M._size_array[i].user}</b></div>
                                </div>
                            <div class="message-balloon" id="message-${id}">
                                <iframe width="300" height="200" src="https://www.facebook.com/plugins/video.php?height=314&href=https%3A%2F%2Fwww.facebook.com%2FSirtonimInt%2Fvideos%2F${M._size_array[i].face}%2F&show_text=false&width=560&t=0"
                                 title="YouTube video player" frameborder="0" 
                                 allow="accelerometer; autoplay; clipboard-write;
                                 encrypted-media; gyroscope; picture-in-picture; web-share" 
                                 allowfullscreen></iframe>
                                <div><sub>${M._size_array[i].time}</sub></div>
                            </div>
                        </div>`
                            postsList.appendChild(row)
                            addCellClick(`message-${id}`, id)
                        }
                        if (M._size_array[i].tiktok !== undefined) {
                            runTikTokScript()
                            const url = M._size_array[i].tiktok
                            const parts = url.split("/");

                            const videoId = parts[parts.length - 1];

                            const id = videoId.split("?");

                            // מקבל את החלק הראשון של הקישור
                            const firstPart = id[0];

                            // מדפיס את ה-id של הסרטון


                            row.innerHTML = `<br/>
                        <div>
                            <div>
                                <img id="user-img" src="${M._img}" width="50px" height="50px" />
                                    <div ><b>${M._size_array[i].user}</b></div>
                                </div>
                        </div>         
                            <div class="message-balloon" id="message-${id}">
                                <blockquote class="tiktok-embed" cite="${M._size_array[i].tiktok}" data-video-id="${firstPart}" style="width="300px" height="200px";" > <section> </section> </blockquote> 

                                <div><sub>${M._size_array[i].time}</sub></div>
                            </div>`
                            postsList.appendChild(row)
                            addCellClick(`message-${id}`, id)
                        }
                    }

                }
                else {
                    row.innerHTML = `<br/>
                    <div class="message-balloon-received" id="message-${id}">
                        <div >:${M._size_array[i].user}</div>
                        <div>${M._size_array[i].text}</div>
                        <div><sub>${M._size_array[i].time}</sub></div>
                    </div>`
                    postsList.appendChild(row)
                    addCellClick(`message-${id}`, id)
                }
            }

        }

        function PUT(number, value) {

            let new_user = M._name
            let new_text = value
            //   document.getElementById(`message-${number}`).value
            let new_time = time_now()
            const url = `https://db-nmn5.onrender.com/chats/${number}`
            fetch(url, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: `{
                            "user": "${new_user}",
                            "text": "${new_text}",
                            "time": "${new_time}"
                        }`
            }).then(response => {
                if (!response.ok) {
                    console.error(response)
                    alert('failure') // 1 -- failure
                }
                else {

                }
            })


        }

        function delete_(number) {

            fetch(`https://db-nmn5.onrender.com/chats/${number}`, {
                method: 'DELETE'

            }).then(response => {
                if (!response.ok) {
                    console.error(response)
                    alert('failure') // 1 -- failure
                } else {
                }
            })
        }

        function edit_or_delete(number) {
            const element = document.getElementById(`message-${number}`);
            const classes = element.className;
            if (classes === "message-balloon") {
                Swal.fire({
                    title: 'Edit or delete the message?',
                    showDenyButton: true,
                    showCancelButton: true,
                    confirmButtonText: 'edit',
                    denyButtonText: `delete`,
                }).then((result) => {
                    /* Read more about isConfirmed, isDenied below */

                    if (result.isConfirmed) {
                        text_editing(number)


                    } else if (result.isDenied) {
                        Swal.fire('The message has been deleted', '', 'info')
                        delete_(number)

                    }
                })
            }
            else {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'You are trying to edit a message that is not yours!',
                })
            }
        }


        function text_editing(number) {
            (async () => {

                const { value: text } = await Swal.fire({
                    input: 'textarea',
                    inputLabel: 'Message',
                    inputPlaceholder: 'Type your message here...',
                    inputAttributes: {
                        'aria-label': 'Type your message here'
                    },
                    showCancelButton: true
                })

                if (text) {
                    [Swal.fire(text)

                    ]
                    PUT(number, text)
                }

            })()
        }

        function addCellClick(divId, number) { //Adds onClick to this div
            const div = document.getElementById(divId);
            div.addEventListener("click", function () {
                // קריאה לפונקציה `cell_click()` עם מספר התמונה
                edit_or_delete(number);
            });
        }
        function runTikTokScript() {
            const script = document.createElement("script");
            script.src = "https://www.tiktok.com/embed.js";
            script.async = false;
            document.body.appendChild(script);
        }
        function runfacebookScript() {
            const script = document.createElement("script");
            script.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.2";
            script.async = false;
            document.body.appendChild(script);
        }

        function getTikTokVideoId(url) {
            // מקבל את החלק האחרון של הקישור באמצעות Regular Expression
            const match = new RegExp("(?<=v=).*").exec(url);

            // מחזיר את מ-id של הסרטון
            return match ? match[0] : null;
        }

      
        intervalId = setInterval(Push_update, 500)



    </script>
</body>

</html>