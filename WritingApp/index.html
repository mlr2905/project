<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WritingApp</title>
    <script src="files js/Types of messages.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.4/dist/jquery.slim.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
    <script src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.2"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

</head>
<style>
    body {
        background-size: cover;
        background-repeat: no-repeat;
        background-attachment: fixed;
        background-color: #f8f9fa;
        /* Fallback background color */
        margin: 0;
        min-height: 100vh;
        background-image: url("wallpaper-dark.jpg");
        width: 80%;
        margin-left: 10%;
    }

    .chat-container {
        background-image: url("w.jpg");
        max-width: 600px;
        margin: 0 auto;
        padding: 20px;
        background-color: rgba(255, 255, 255, 0.9);
        /* Semi-transparent white background */
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        /* Box shadow for a card-like appearance */
        border: 1px solid #ccc;
        display: flex;
        /* Use flexbox to control container's height */
        flex-direction: column;
        /* Display latest message at the bottom */
        overflow-y: auto;
        margin-left: 20%;
    }

    .message-balloon {
        background-color: #035d4c;
        /* Green background for sent messages */
        color: #fff;
        /* Text color for sent messages */
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 20px;
        clear: both;
        float: left;
        width: auto;
        text-align: left;
    }

    .message-balloon-received {
        background-color: #1f2c34;
        /* White background for received messages */
        color: #fff;
        /* Text color for received messages */
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 20px;
        clear: both;
        float: right;
        width: auto;
        text-align: right;

    }





    #text {
        border: 0;
        flex: 1 1 auto;
        font-size: 16px;
        margin: 0;
        outline: none;
        min-width: 50px;
        margin-left: 30%;
    }

    /* .iconify-icon {
        height: calc(100% - 68px);
        box-shadow: inset 0 10px 10px -10px #000000;
        overflow-x: hidden;
        padding: 0 16px;
        margin-bottom: 19px;
    } */

    #user_img {
        border-radius: 30px;
        width: 50px;
        height: 50px;

    }

    #Another_user {
        border-radius: 30px;
        width: 50px;
        height: 50px;
        text-align: right;
        margin-left: 90%;
    }

    .date_day {
        background-color: #1f2c34;
        /* Green background for sent messages */
        color: #fff;
        /* Text color for sent messages */
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 10px;
        width: 20%;
        text-align: center;
        margin-left: 40%;
        margin-right: 50%;

    }

    .input-msg {
        border: 0;
        flex: 1 1 auto;
        font-size: 16px;
        margin: 0;
        outline: none;
        min-width: 50px;
    }


    conversation-compose .photo:after {
        border-width: 0px 0 10px 10px;
        border-color: transparent transparent transparent #fff;
        border-style: solid;
        position: absolute;
        width: 0;
        height: 0;
        content: "";
        top: 0;
        right: -10px;
    }

    .photo i {
        display: block;
        color: #7d8488;
        font-size: 24px;
        transform: translate(-50%, -50%);
        position: relative;
        top: 50%;
        left: 50%;
    }

    .conversation-compose {
        display: flex;
        flex-direction: row;
        align-items: flex-end;
        overflow: hidden;
        height: 50px;
        width: 90%;
        z-index: 2;
    }

    .conversation-compose div,
    .conversation-compose input {
        background: #fff;
        height: 100%;
    }

    .conversation-compose .emoji {
        display: flex;
        align-items: center;
        justify-content: center;
        background: white;
        border-radius: 5px 0 0 5px;
        flex: 0 0 auto;
        margin-left: 8px;
        width: 48px;
    }



    .conversation-compose .photo:after {
        border-width: 0px 0 10px 10px;
        border-color: transparent transparent transparent #fff;
        border-style: solid;
        position: absolute;
        width: 0;
        height: 0;
        content: "";
        top: 0;
        right: -10px;
    }

    .conversation-compose .photo i {
        display: block;
        color: #7d8488;
        font-size: 24px;
        transform: translate(-50%, -50%);
        position: relative;
        top: 50%;
        left: 50%;
    }

    .conversation-compose .send {
        background: transparent;
        border: 0;
        cursor: pointer;
        flex: 0 0 auto;
        margin-left: 8px;
        margin-right: 8px;
        padding: 0;
        position: relative;
        outline: none;
    }

    .conversation-compose .send .circle {
        background: #008a7c;
        border-radius: 50%;
        color: #fff;
        position: relative;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .conversation-compose .send .circle i {
        font-size: 24px;
        margin-left: 5px;
    }

    #image {
        background-color: #fff;
    }

    /* Small Screens */
</style>

<body>

    <h1>WritingApp</h1>

    <div class="chat-container" style="display: none;" id="tableBody"></div>

        <div class="conversation-compose">
            <input type="text" id="text" placeholder="Type a message" autocomplete="off" autofocus>
            <button class="send" id="post-button" onclick="post_data()">
                <samp class="circle">
                    <iconify-icon icon="zmdi:mail-send"></iconify-icon>
                </samp>
            </button>
        </div>
        <form class=" mt-5 mx-auto col-6 col-md-8 col-lg-6 was-validated " id="from" style="display: block;">
            <div class="form-row">
                <div class="col-md-4 mb-3">
                    <input type="name" class="form-control" id="name" placeholder="Jane Doe.." value="" required>
                </div>
                <div class="col-md-4 mb-3">
                    <input type="number" class="form-control mb-2" id="Phone" minlength="9" maxlength="10"
                        placeholder="050-1234567.." min="10" required><br />
                </div>
                <div class="custom-file col-md-4 mb-3">
                    <input type="file" onchange="add_img()" class="custom-file-input" id="files" required>
                    <label class="custom-file-label" for="file"><b>add a picture..</b></label>
                </div>
            </div>
            <button onclick="activation()" class="btn btn-primary col" type="button">connect</button>
        </form>
    
    <img id="frame" style="display: none;" src="" width="0px" height="0px" />

    <script>

        class Default_cells {
            constructor(_name, _img, _img_user, _Push, _size_array, _new_text, _new_time, _string_name, _message_list, _son, _type_class, _type_id, _time_date) {
                this.name = _name
                this.img_user = _img_user
                this.img = _img
                this.Push = _Push
                this.size_array = _size_array
                this.new_text = _new_text
                this.new_time = _new_time
                this.string_name = _string_name
                this.message_list = _message_list
                this.son = _son
                this.type_class = _type_class
                this.type_id = _type_id
                this.time_date = _time_date

            }
        }
        const Cells_manager = new Default_cells(" ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ", " ")
        Cells_manager.son
        function Push_update() {
            fetch("https://db-nmn5.onrender.com/chats")
                .then(res => res.json())
                .then(data => {
                    localStorage.setItem("check", JSON.stringify(data));
                    Cells_manager.Push = JSON.parse(localStorage.getItem("check"));
                    if (Cells_manager.name !== '') {
                        if (Cells_manager.Push.length !== Cells_manager.size_array.length) {
                            Cells_manager.Push = 0;
                            get();
                        }
                    }
                });
        }
        function Hide_div() {
            const div1 = document.getElementById("tableBody");
            div1.style.display = div1.style.display === "none" ? "block" : "none";
            const div2 = document.getElementById("from");
            div2.style.display = div2.style.display === "block" ? "none" : "none";
        }

        function activation() {
            Cells_manager.name = document.getElementById('name').value
            if (Cells_manager.name !== '') {
                Hide_div()

                Cells_manager.size_array = []

            }
            else {
                Swal.fire('Must enter a name', '', 'success')
            }
        }

        function add_img() {
            frame.src = URL.createObjectURL(event.target.files[0]);
            Cells_manager.img_user = frame.src
        }


        function post_data() {

            Cells_manager.string_name = "text"
            link_type()
            const input = document.getElementById('text')
            input.value = '';

            const url = 'https://db-nmn5.onrender.com/chats'
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: `{
                            "user": "${Cells_manager.name}",
                            "${Cells_manager.string_name}": "${Cells_manager.new_text}",
                            "time": "${Cells_manager.new_time}"
                        }`})
        }


        function isLink_img(text) {
            return text.includes(".gif") || text.includes(".png") ||
                text.includes(".jpg") || text.includes(".svg") || text.includes(".jpeg");
        }
        function link_type() {
            Cells_manager.new_text = document.getElementById('text').value
            Cells_manager.new_time = time_now()
            let img_or_no = isLink_img(Cells_manager.new_text)
            let tube_or_no = Cells_manager.new_text.includes("youtu") || Cells_manager.new_text.includes("youtube")
            let tiktok_or_no = Cells_manager.new_text.includes("tiktok")
            let facebook_or_on = Cells_manager.new_text.includes("facebook")
            let link_or_no = Cells_manager.new_text.includes("http")

            Cells_manager.string_name = img_or_no ? "img" : tiktok_or_no ? "tiktok" : tube_or_no ? "tube" : "text";
            const all_or_no = !img_or_no && !tiktok_or_no && !tube_or_no && !facebook_or_on
            if (all_or_no) {
                if (link_or_no) {
                    Cells_manager.string_name = "link"
                }
            }

            if (facebook_or_on) {
                Cells_manager.new_text = Cells_manager.new_text.split("=")[1];
                Cells_manager.string_name = "face";
            }
        }


        function time_now() {
            Cells_manager.time_date = new Date();

            const hours = Cells_manager.time_date.getHours();

            const minutes = Cells_manager.time_date.getMinutes();

            const seconds = Cells_manager.time_date.getSeconds();
            let time = `${hours}:${minutes}:${seconds}`

            return time
        }

        function date_day_now() {
            Cells_manager.time_date = new Date();

            const day = Cells_manager.time_date.getDate()

            const Month = Cells_manager.time_date.getMonth() + 1

            const Year = Cells_manager.time_date.getFullYear()

            let Date_dey = `${day}/${Month}/${Year}`

            return Date_dey
        }

        function get() {

            fetch("https://db-nmn5.onrender.com/chats")
                .then(res => res.json())
                .then(data => {
                    localStorage.setItem("db-chats", JSON.stringify(data));
                })

            Cells_manager.size_array = JSON.parse(localStorage.getItem("db-chats"))

            Cells_manager.message_list = document.getElementById('tableBody')
            Cells_manager.message_list.innerHTML = ""
            const data_day = date_day_now()
            const div = document.getElementById('tableBody')
            const son = document.createElement('div')
            son.innerHTML = `<div class="date_day">${data_day}</div>`
            div.appendChild(son)
            for (let i = 0; i < Cells_manager.size_array.length; i++) {
                Cells_manager.son = document.createElement('div')

                let id = Cells_manager.size_array[i].id
                if (Cells_manager.size_array[i].user === Cells_manager.name) {

                    Cells_manager.type_class = "message-balloon"

                    Cells_manager.img = Cells_manager.img_user
                    Cells_manager.type_id = "user_img"

                }
                else {
                    Cells_manager.img = "bot.png"
                    Cells_manager.type_class = "message-balloon-received"
                    Cells_manager.type_id = "Another_user"
                }
                if (Cells_manager.size_array[i].text !== undefined) {
                    text_message(i, id)
                }
                else {
                    if (Cells_manager.size_array[i].img !== undefined) {
                        image_Message(i, id)
                    }
                    if (Cells_manager.size_array[i].link !== undefined) {
                        link_message(i, id)
                    }
                    if (Cells_manager.size_array[i].tube !== undefined) {
                        youtube_message(i, id)
                    }
                    if (Cells_manager.size_array[i].face !== undefined) {
                        facebook_message(i, id)
                        runfacebookScript()
                    }
                    if (Cells_manager.size_array[i].tiktok !== undefined) {
                        runTikTokScript()
                        tiktok_message(i, id)
                    }
                }

            }

        }





        function PUT(number, value) {

            Cells_manager.new_text = value
            //   document.getElementById(`message-${number}`).value
            Cells_manager.new_time = time_now()
            const url = `https://db-nmn5.onrender.com/chats/${number}`
            fetch(url, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: `{
                            "user": "${Cells_manager.name}",
                            "text": "${Cells_manager.new_text}",
                            "time": "${Cells_manager.new_time}"
                        }`
            }).then(response => {
                if (!response.ok) {
                    console.error(response)
                    alert('failure') // 1 -- failure
                }
                else {

                }
            })


        }

        function delete_(number) {

            fetch(`https://db-nmn5.onrender.com/chats/${number}`, {
                method: 'DELETE'

            }).then(response => {
                if (!response.ok) {
                    console.error(response)
                    alert('failure') // 1 -- failure
                } else {
                }
            })
        }

        function edit_or_delete(number) {
            const element = document.getElementById(`message-${number}`);
            const classes = element.className;
            if (classes === "message-balloon") {
                Swal.fire({
                    title: 'Edit or delete the message?',
                    showDenyButton: true,
                    showCancelButton: true,
                    confirmButtonText: 'edit',
                    denyButtonText: `delete`,
                }).then((result) => {
                    /* Read more about isConfirmed, isDenied below */

                    if (result.isConfirmed) {
                        text_editing(number)


                    } else if (result.isDenied) {
                        Swal.fire('The message has been deleted', '', 'info')
                        delete_(number)

                    }
                })
            }
            else {
                Swal.fire({
                    icon: 'error',
                    title: 'Oops...',
                    text: 'You are trying to edit a message that is not yours!',
                })
            }
        }


        function text_editing(number) {
            (async () => {

                const { value: text } = await Swal.fire({
                    input: 'textarea',
                    inputLabel: 'Message',
                    inputPlaceholder: 'Type your message here...',
                    inputAttributes: {
                        'aria-label': 'Type your message here'
                    },
                    showCancelButton: true
                })

                if (text) {
                    [Swal.fire(text)

                    ]
                    PUT(number, text)
                }

            })()
        }

        function addCellClick(divId, number) { //Adds onClick to this div
            const div = document.getElementById(divId);
            div.addEventListener("click", function () {
                // קריאה לפונקציה `cell_click()` עם מספר התמונה
                edit_or_delete(number);
            });
        }
        function runTikTokScript() {
            const script = document.createElement("script");
            script.src = "https://www.tiktok.com/embed.js";
            script.async = false;
            document.body.appendChild(script);
        }
        function runfacebookScript() {
            const script = document.createElement("script");
            script.src = "https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v3.2";
            script.async = false;
            document.body.appendChild(script);
        }



        intervalId = setInterval(Push_update, 500)



    </script>
</body>

</html>